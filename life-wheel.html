<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Life Wheel Exercise</title>
  <style>
    :root{
      --brand-blue:#3B82F6; --pill-blue:#60A5FA;
      --bg:#FAFAFA; --text:#334155; --muted:#E5E7EB;
      /* 8 pastel area colors (stable order) */
      --area-1:#FFD6A5; --area-2:#CAFFBF; --area-3:#BDE0FE; --area-4:#FFC6FF;
      --area-5:#FDFFB6; --area-6:#A7F3D0; --area-7:#C7D2FE; --area-8:#FBCFE8;
    }
    html,body{background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; margin:0;}
    .wrap{max-width:900px; margin:0 auto; padding:24px;}
    .card{background:#fff; border:1px solid var(--muted); border-radius:16px; padding:18px 18px;}
    h1{margin:0 0 6px 0; font-size:28px; font-weight:700}
    .sub{color:#64748B; font-size:14px; margin-bottom:14px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .col{flex:1 1 260px}
    label{font-size:12px; color:#475569}
    input[type="text"], input[type="email"]{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--muted); font-size:14px; outline:none;
    }
    .btn{display:inline-block; background:var(--brand-blue); color:#fff; border:none; padding:10px 14px; border-radius:999px; font-weight:600; cursor:pointer}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .pill{display:inline-block; background:var(--pill-blue); color:#fff; border-radius:999px; padding:2px 10px; font-size:12px; font-weight:700}
    .section{margin-top:18px}
    .title{font-weight:700; font-size:16px; margin-bottom:8px}
    .help{font-size:14px; color:#475569; line-height:1.45}
    .grid-4{display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:10px}
    .tile{border:1px solid var(--muted); border-radius:14px; padding:12px; background:#fff; cursor:pointer; position:relative}
    .tile input{width:100%; border:none; outline:none; font-size:14px; background:transparent; color:var(--text)}
    .ring{box-shadow:0 0 0 2px var(--pill-blue) inset}
    .slider-row{display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px dashed var(--muted)}
    .slider-row:last-child{border-bottom:none}
    .area-dot{width:12px; height:12px; border-radius:50%;}
    .slider{flex:1}
    input[type="range"]{width:100%}
    .center{display:flex; justify-content:center; align-items:center}
    canvas{max-width:100%; height:auto; background:#fff; border:1px solid var(--muted); border-radius:16px}
    .notice{font-size:13px; color:#475569}
    .spacer{height:10px}
    .hr{height:1px; background:var(--muted); margin:12px 0}
  </style>
  <!-- jsPDF UMD (vector PDFs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YkqQk2m12t0sY1xkH0EOb7F0lJkG9FzC4s4FQbqGz5nKQ8k3nQ1m5m1qXo1vdxz+Qw9kG7YpH8YwS4n5m+6Q8A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // expose jsPDF in window for convenience
    if (!window.jsPDF && window.jspdf && window.jspdf.jsPDF) { window.jsPDF = window.jspdf.jsPDF; }
  </script>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="card">
      <h1>Life Wheel Exercise</h1>
      <div class="sub">A snapshot of ‘now’ to guide our coaching.</div>
      <div class="row">
        <div class="col">
          <label>Full name</label>
          <input id="clientName" type="text" placeholder="e.g., Alex Parker" />
        </div>
        <div class="col">
          <label>Client email</label>
          <input id="clientEmail" type="email" placeholder="you@example.com" />
        </div>
      </div>
    </div>

    <!-- Welcome -->
    <div class="card section">
      <div class="title">Welcome</div>
      <div class="help">
        The Life Wheel exercise is a simple way to get a snapshot of your life as you see it today. It helps us
        understand how satisfied you are with different areas of your life and can reveal patterns you may want to
        focus on in our time together. The goal is to notice what is true today rather than what is 'should' or 'could' be.
      </div>
    </div>

    <!-- Step 1: Areas -->
    <div class="card section">
      <div class="title"><b>Step 1:</b></div>
      <div class="help" style="margin-bottom:10px">
        Here are the eight areas of your life that you’ll be thinking about. If an area doesn’t align with your life, click it and change it to one that does.
      </div>
      <div id="areaGrid" class="grid-4"></div>
    </div>

    <!-- Step 2: Satisfaction -->
    <div class="card section">
      <div class="title"><b>Step 2:</b></div>
      <div class="help" style="margin:10px 0 14px 0">
        Please rate your level of satisfaction in each area of your life in this moment. Go with your first instinct; there are no right or wrong answers.
      </div>
      <div id="satList"></div>
      <div class="spacer"></div>
      <button id="toImportance" class="btn">Continue</button>
    </div>

    <!-- Step 3: Importance -->
    <div class="card section">
      <div class="title"><b>Step 3:</b></div>
      <div class="help" style="margin:10px 0 14px 0">
        For this section you are rating how important each area is to you right now. Again, there are no right or wrong answers.
      </div>
      <div id="impList"></div>
      <div class="spacer"></div>
      <button id="toResults" class="btn">Continue</button>
    </div>

    <!-- Results -->
    <div class="card section">
      <div class="help" style="margin-bottom:10px">
        Here is your Life Wheel, a snapshot of ‘now’. Use the toggle to view Satisfaction or Importance. Don't worry, you don't need to remember this—your results will arrive by email to both of us.
      </div>
      <div class="row" style="align-items:flex-start">
        <div class="col" style="flex:1 1 360px">
          <div class="row" style="gap:8px; align-items:center; margin-bottom:8px">
            <label>View:</label>
            <button id="viewSat" class="btn" style="background:var(--pill-blue)">Satisfaction</button>
            <button id="viewImp" class="btn" style="background:#94A3B8">Importance</button>
          </div>
          <div class="center"><canvas id="wheel" width="480" height="480"></canvas></div>
          <div class="notice" style="margin-top:8px">White center ring = hub; wedge size grows with your rating.</div>
        </div>
        <div class="col" style="flex:1 1 360px">
          <div id="pillList" class="row" style="gap:8px; flex-wrap:wrap"></div>
        </div>
      </div>
      <div class="hr"></div>
      <button id="submitAll" class="btn">Submit (email PDFs)</button>
      <span id="status" class="notice" style="margin-left:8px"></span>
    </div>
  </div>

  <script>
    // ----------------------- DATA & STATE -----------------------
    const DEFAULT_AREAS = [
      "Health","Relationships","Family","Spirituality",
      "Career","Finances","Learning","Leisure"
    ];
    const COLORS = [
      getCSS('--area-1'),getCSS('--area-2'),getCSS('--area-3'),getCSS('--area-4'),
      getCSS('--area-5'),getCSS('--area-6'),getCSS('--area-7'),getCSS('--area-8')
    ];

    function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    // persistent ids are stable across renames
    const areas = DEFAULT_AREAS.map((name, i) => ({ id:`a${i+1}`, name, color:COLORS[i] }));
    const satisfaction = {}; // by id (0-10)
    const importance   = {}; // by id (0-10)
    let currentView = 'sat'; // 'sat' | 'imp'

    // Try import areas from life wheel localStorage if present
    try {
      const stored = JSON.parse(localStorage.getItem('lw_areas')||'null');
      if (stored && Array.isArray(stored) && stored.length === 8) {
        for (let i=0;i<8;i++){ areas[i].name = stored[i].name || areas[i].name; }
      }
    } catch(_){}

    // ----------------------- UI BUILDERS -----------------------
    function buildAreaGrid(){
      const grid = qs('#areaGrid'); grid.innerHTML = '';
      areas.forEach((a, idx) => {
        const t = document.createElement('div');
        t.className = 'tile';
        t.style.borderColor = '#e5e7eb';
        t.innerHTML = `
          <div class="row" style="align-items:center">
            <div class="area-dot" style="background:${a.color}"></div>
            <input type="text" value="${a.name}" />
          </div>
        `;
        const input = t.querySelector('input');
        input.addEventListener('input', () => {
          areas[idx].name = input.value.trim() || DEFAULT_AREAS[idx];
          saveAreas();
          refreshSlidersAndPills();
        });
        grid.appendChild(t);
      });
    }

    function buildSliderList(containerId, store){
      const cont = qs(containerId); cont.innerHTML = '';
      areas.forEach((a) => {
        const row = document.createElement('div'); row.className = 'slider-row';
        row.innerHTML = `
          <div class="area-dot" style="background:${a.color}"></div>
          <div style="min-width:120px">${a.name}</div>
          <div class="slider"><input type="range" min="0" max="10" step="1" value="${store[a.id] ?? 0}"></div>
          <div class="pill" style="background:var(--pill-blue)"><span>${store[a.id] ?? 0}</span>/10</div>
        `;
        const range = row.querySelector('input[type="range"]');
        const pill = row.querySelector('.pill span');
        range.addEventListener('input', () => {
          store[a.id] = Number(range.value);
          pill.textContent = store[a.id];
          drawWheel();
          refreshPills();
        });
        cont.appendChild(row);
      });
    }

    function refreshSlidersAndPills(){
      buildSliderList('#satList', satisfaction);
      buildSliderList('#impList', importance);
      refreshPills();
      drawWheel();
    }

    function refreshPills(){
      const wrap = qs('#pillList'); wrap.innerHTML = '';
      areas.forEach((a, i) => {
        const n = currentView==='sat' ? (satisfaction[a.id]??0) : (importance[a.id]??0);
        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.style.background = a.color;
        pill.style.color = '#111827';
        pill.textContent = `${a.name} ${n}`;
        wrap.appendChild(pill);
      });
    }

    // ----------------------- WHEEL DRAWING -----------------------
    function drawWheel(){
      const canvas = qs('#wheel');
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);
      const cx = w/2, cy = h/2;
      const R = Math.min(w,h)*0.38;
      const innerR = R*0.15; // white center ring

      const values = areas.map(a => (currentView==='sat' ? (satisfaction[a.id]??0) : (importance[a.id]??0)));
      const max = 10;

      const n = areas.length;
      const ang = (2*Math.PI)/n;

      // background wedges
      for (let i=0;i<n;i++){
        const start = -Math.PI/2 + i*ang, end = start + ang;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,R,start,end);
        ctx.closePath();
        ctx.fillStyle = lighten(colors(i), 0.65);
        ctx.fill();
      }
      // filled wedges
      for (let i=0;i<n;i++){
        const v = (values[i]||0)/max;
        const r = innerR + (R-innerR)*v;
        const start = -Math.PI/2 + i*ang, end = start + ang;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,start,end);
        ctx.closePath();
        ctx.fillStyle = colors(i);
        ctx.fill();
      }
      // white ring
      ctx.beginPath();
      ctx.arc(cx,cy,innerR,0,2*Math.PI);
      ctx.fillStyle = '#fff';
      ctx.fill();
    }

    function colors(i){ return COLORS[i % COLORS.length]; }
    function lighten(hex, amt){
      const [r,g,b]=hexToRgb(hex);
      const L = (x)=>Math.round(x + (255-x)*amt);
      return `rgb(${L(r)},${L(g)},${L(b)})`;
    }
    function hexToRgb(hex){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex.trim());
      if(!m) return [96,165,250]; // pill blue fallback
      return [parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)];
    }

    // ----------------------- PDF BUILDERS -----------------------
    function fitTextOneLine(pdf, text, maxWidth, maxFs, minFs){
      for (let fs=maxFs; fs>=minFs; fs--){
        pdf.setFontSize(fs);
        if (pdf.getTextWidth(text) <= maxWidth) return fs;
      }
      return minFs;
    }

    // vector wheel for PDF
    function drawWheelVectorPDF(pdf, { cx, cy, rOuter, rInner, areas, sat, imp }){
      const n = areas.length, ang = (2*Math.PI)/n, max=10;
      // bg wedges
      for (let i=0;i<n;i++){
        const [R,G,B] = hexToRgb(COLORS[i]);
        pdf.setFillColor(
          Math.round(R+(255-R)*0.65),
          Math.round(G+(255-G)*0.65),
          Math.round(B+(255-B)*0.65)
        );
        const pathBg = wedgePath(cx,cy,rOuter,-Math.PI/2+i*ang,-Math.PI/2+(i+1)*ang);
        pdf.lines(pathBg, 0,0, [1], 'F', true);
      }
      // filled wedges (current view doesn't matter for PDF wheel—show both as overlay if you wish;
      // to keep it simple and crisp, we draw Satisfaction height here.)
      for (let i=0;i<n;i++){
        const v = Number(sat[i] ?? 0)/max;
        const r = rInner + (rOuter - rInner)*v;
        const [R,G,B] = hexToRgb(COLORS[i]);
        pdf.setFillColor(R,G,B);
        const path = wedgePath(cx,cy,r,-Math.PI/2+i*ang,-Math.PI/2+(i+1)*ang);
        pdf.lines(path, 0,0, [1], 'F', true);
      }
      // white hub
      pdf.setFillColor(255,255,255);
      pdf.circle(cx,cy,rInner,'F');
    }

    function wedgePath(cx,cy,r, start, end){
      // returns polyline approximating arc (jsPDF lines: [ [dx,dy], ... ])
      const steps = 16;
      const pts = [[cx, cy]]; // move from origin for jsPDF.lines offset
      for (let s=0;s<=steps;s++){
        const a = start + (end-start)*(s/steps);
        pts.push([cx + r*Math.cos(a), cy + r*Math.sin(a)]);
      }
      // convert to relative deltas for jsPDF.lines
      const rel = [];
      for (let i=1;i<pts.length;i++){
        rel.push([pts[i][0]-pts[i-1][0], pts[i][1]-pts[i-1][1]]);
      }
      return rel;
    }

    function buildPDFs({ name, email, coachName }){
      const pageW=210, pageH=297, marginX=14;
      const pdf1 = new jsPDF({ unit: 'mm', format: 'a4', compress: true });
      const pdf2 = new jsPDF({ unit: 'mm', format: 'a4', compress: true });

      const brandBlue = getCSS('--pill-blue') || '#60A5FA';
      const [bbR,bbG,bbB] = hexToRgb(brandBlue);
      const cardBorder = '#93C5FD';
      const [cbR,cbG,cbB] = hexToRgb(cardBorder);

      // Header pdf1
      pdf1.setFont('helvetica','normal'); pdf1.setFontSize(14);
      pdf1.text(`Quality of Life Wheel — ${name}`, marginX, 18);
      pdf1.setFontSize(10);
      pdf1.text(`Coach: ${coachName || 'Your Coach'}`, marginX, 24);
      pdf1.text(`Email: ${email}`, marginX, 29);

      const cx = pageW/2, cy = 70, rOuter=50, rInner=4;
      const satArr = areas.map(a => Number(satisfaction[a.id]??0));
      const impArr = areas.map(a => Number(importance[a.id]??0));

      drawWheelVectorPDF(pdf1, { cx, cy, rOuter, rInner, areas: areas.map(a=>a.name), sat: satArr, imp: impArr });

      // Pills
      let startY1 = cy + rOuter + 12;
      const cols = 4, gap = 6, tileH = 16;
      const tileW = (pageW - marginX*2 - gap*(cols-1))/cols;
      for (let i=0;i<areas.length;i++){
        const col=i%cols, row=Math.floor(i/cols);
        const x = marginX + col*(tileW + gap), y = startY1 + row*(tileH + 6);
        const [r,g,b]=hexToRgb(COLORS[i]);
        pdf1.setFillColor(r,g,b);
        pdf1.roundedRect(x,y,tileW,tileH,3,3,'F');
        const label = `${areas[i].name}  ${satArr[i]}/${impArr[i]}`;
        const fs = fitTextOneLine(pdf1, label, tileW-8, 11, 8);
        pdf1.setFontSize(fs); pdf1.text(label, x+tileW/2, y+tileH/2+2.2, {align:'center'});
      }

      // Header pdf2
      pdf2.setFont('helvetica','normal'); pdf2.setFontSize(14);
      pdf2.text(`Quality of Life Wheel — Insights — ${name}`, marginX, 18);
      pdf2.setFontSize(10);
      pdf2.text(`Coach: ${coachName || 'Your Coach'}`, marginX, 24);
      pdf2.text(`Email: ${email}`, marginX, 29);

      const cx2=pageW/2, cy2=70, r2=50;
      drawWheelVectorPDF(pdf2, { cx:cx2, cy:cy2, rOuter:r2, rInner:4, areas: areas.map(a=>a.name), sat: satArr, imp: impArr });

      // ------------- FIXED & STABLE GAP SELECTION -------------
      const rows = areas.map((a, i) => {
        const s = Number(satArr[i] ?? 0);
        const m = Number(impArr[i] ?? 0);
        return { i, area: a.name, gap: m - s, idx: i };
      });

      const positives = rows
        .filter(r => r.gap > 0)
        .sort((a,b) => (b.gap - a.gap) || (a.idx - b.idx)); // DESC, stable

      const top3 = positives.slice(0,3);

      const rest = positives.slice(3).concat(
        rows
          .filter(r => r.gap <= 0)
          .sort((a,b) => (b.gap - a.gap) || (a.idx - b.idx))
      );

      // Top-3 box
      let startY2 = cy2 + r2 + 12;
      const tileH2=16;
      if (top3.length>0){
        const contentWTop = pageW - marginX*2 - 2;
        const colsTop = Math.max(1, top3.length);
        const gapTop = 6;
        const tileWTop = (contentWTop - gapTop*(colsTop-1))/colsTop;

        const boxPad=4, boxW=contentWTop+boxPad*2, boxH=tileH2+boxPad*2, boxX=marginX-1, boxY=startY2;
        pdf2.setDrawColor(cbR,cbG,cbB); pdf2.setLineWidth(0.5);
        pdf2.roundedRect(boxX, boxY, boxW, boxH, 3, 3, 'S');

        for (let idx=0; idx<top3.length; idx++){
          const r = top3[idx]; const [fr,fg,fb]=hexToRgb(COLORS[r.i]);
          const x = boxX + boxPad + idx*(tileWTop + gapTop), yy = boxY + boxPad;
          pdf2.setFillColor(fr,fg,fb); pdf2.roundedRect(x, yy, tileWTop, tileH2, 3, 3, 'F');
          const gDisp = Math.abs(r.gap);
          const label = `${r.area} Gap = ${gDisp}`;
          const fs = fitTextOneLine(pdf2, label, tileWTop-8, 11, 8);
          pdf2.setFontSize(fs); pdf2.text(label, x+tileWTop/2, yy+tileH2/2+2.2, {align:'center'});
        }
        startY2 = boxY + boxH + 10;
      }

      // Remaining tiles grid
      const colsG=4, gapG=6, tileWG=(pageW - marginX*2 - gapG*(colsG-1))/colsG;
      for (let idx=0; idx<rest.length; idx++){
        const r = rest[idx]; const col=idx%colsG, row=Math.floor(idx/colsG);
        const x = marginX + col*(tileWG + gapG), yy = startY2 + row*(tileH2 + 6);
        const [fr,fg,fb]=hexToRgb(COLORS[r.i]);
        pdf2.setFillColor(fr,fg,fb); pdf2.roundedRect(x, yy, tileWG, tileH2, 3,3,'F');
        const gDisp = (r.gap == null ? '—' : Math.abs(r.gap));
        const label = `${r.area} Gap = ${gDisp}`;
        const fs = fitTextOneLine(pdf2, label, tileWG-8, 11, 8);
        pdf2.setFontSize(fs); pdf2.text(label, x+tileWG/2, yy+tileH2/2+2.2, {align:'center'});
      }

      // Filenames
      const today = new Date(), yyyy=today.getFullYear(),
            mm=String(today.getMonth()+1).padStart(2,'0'),
            dd=String(today.getDate()).padStart(2,'0');
      const fileName1 = `Life-Wheel_${(name||'Client').replace(/\s+/g,'-')}_${yyyy}-${mm}-${dd}.pdf`;
      const fileName2 = `Life-Wheel-Details_${(name||'Client').replace(/\s+/g,'-')}_${yyyy}-${mm}-${dd}.pdf`;

      return { pdf1, pdf2, fileName1, fileName2 };
    }

    // ----------------------- EMAIL SEND -----------------------
    async function sendResults(){
      const name = (qs('#clientName').value || '').trim();
      const email = (qs('#clientEmail').value || '').trim();
      if (!name || !email){ qs('#status').textContent = 'Please enter your name and email.'; return; }

      const coachId = new URLSearchParams(location.search).get('c') || (location.pathname.split('/')[1] || '').toLowerCase() || 'meltest';
      const coachName = ''; // optional to show in PDF header

      // build PDFs
      const { pdf1, pdf2, fileName1, fileName2 } = buildPDFs({ name, email, coachName });

      // export to datauristring (compact)
      const pdf1DataUri = pdf1.output('datauristring');
      const pdf2DataUri = pdf2.output('datauristring');

      const payload = {
        coach_id: coachId,
        exercise_type: 'life-wheel',
        client_name: name,
        client_email: email,
        pdf1: pdf1DataUri,
        pdf1_name: fileName1,
        pdf2: pdf2DataUri,
        pdf2_name: fileName2
      };

      qs('#status').textContent = 'Sending…';
      try{
        const res = await fetch('/.netlify/functions/send', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(await res.text());
        qs('#status').textContent = 'Your results have been emailed.';
      }catch(err){
        console.error('Email error:', err);
        qs('#status').textContent = 'There was a problem sending your results. Please try again.';
      }
    }

    // ----------------------- INIT -----------------------
    function saveAreas(){
      try { localStorage.setItem('lw_areas', JSON.stringify(areas.map(a=>({id:a.id,name:a.name,color:a.color})))); } catch(_){}
    }

    function init(){
      // fill defaults
      areas.forEach(a => { satisfaction[a.id] ??= 0; importance[a.id] ??= 0; });
      buildAreaGrid();
      refreshSlidersAndPills();
      drawWheel();

      qs('#viewSat').addEventListener('click', () => {
        currentView='sat'; drawWheel(); refreshPills();
        qs('#viewSat').style.background='var(--pill-blue)';
        qs('#viewImp').style.background='#94A3B8';
      });
      qs('#viewImp').addEventListener('click', () => {
        currentView='imp'; drawWheel(); refreshPills();
        qs('#viewImp').style.background='var(--pill-blue)';
        qs('#viewSat').style.background='#94A3B8';
      });

      qs('#toImportance').addEventListener('click', () => {
        window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
      });
      qs('#toResults').addEventListener('click', () => {
        currentView='sat'; drawWheel(); refreshPills();
        window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
      });
      qs('#submitAll').addEventListener('click', sendResults);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
